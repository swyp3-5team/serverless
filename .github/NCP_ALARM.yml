name: NCP Alarm to Discord

on:
  repository_dispatch:
    types: [ncp_alarm]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send Notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          SERVER: ${{ github.event.client_payload.server_name }}
          METRIC: ${{ github.event.client_payload.metric }}
          VALUE: ${{ github.event.client_payload.current_value }}
          STATUS: ${{ github.event.client_payload.status }}

        run: |
          set -e

          cat <<EOF > payload.json
          {
            "content": "**ğŸš¨ NCP ì„œë²„ ì•Œë¦¼ ë°œìƒ**",
            "embeds": [
              {
                "title": "${SERVER} ìƒíƒœ ë³´ê³ ",
                "color": 15158332,
                "fields": [
                  { "name": "ëŒ€ìƒ ì„œë²„", "value": "${SERVER}", "inline": true },
                  { "name": "ìƒíƒœ", "value": "${STATUS}", "inline": true },
                  { "name": "ê°ì§€ëœ ì§€í‘œ", "value": "${METRIC}", "inline": true },
                  { "name": "í˜„ì¬ ê°’", "value": "${VALUE}", "inline": true }
                ],
                "footer": {
                  "text": "GitHub Actions via NCP Cloud Insight"
                }
              }
            ]
          }
          EOF

          curl -f -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "$DISCORD_WEBHOOK"
